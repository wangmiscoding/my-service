<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             typeLanguage="http://www.w3.org/2001/XMLSchema"
             expressionLanguage="http://www.w3.org/1999/XPath"
             targetNamespace="http://flowable.org/bpmn20">

    <process id="orderApprovalProcess" name="订单审批流程" isExecutable="true">
        <!-- 开始事件 -->
        <startEvent id="startEvent" name="订单提交">
            <extensionElements>
                <flowable:formProperty id="orderId" name="订单ID" type="long" required="true" />
                <flowable:formProperty id="orderNo" name="订单编号" type="string" required="true" />
                <flowable:formProperty id="amount" name="订单金额" type="double" required="true" />
                <flowable:formProperty id="customerName" name="客户名称" type="string" required="true" />
            </extensionElements>
        </startEvent>

        <!-- 用户任务：订单审批 -->
        <userTask id="approveTask" name="订单审批">
            <documentation>审批订单申请</documentation>
            <extensionElements>
                <flowable:formProperty id="approved" name="是否通过" type="boolean" required="true" />
            </extensionElements>
            <potentialOwner>
                <resourceAssignmentExpression>
                    <formalExpression>admin</formalExpression>
                </resourceAssignmentExpression>
            </potentialOwner>
        </userTask>

        <!-- 网关：审批决策 -->
        <exclusiveGateway id="decisionGateway" name="审批决策" />

        <!-- 结束事件：审批通过 -->
        <endEvent id="approvedEndEvent" name="审批通过">
            <extensionElements>
                <flowable:executionListener event="start" class="org.flowable.engine.impl.bpmn.listener.ScriptExecutionListener">
                    <flowable:field name="script">
                        <flowable:string><![CDATA[System.out.println("订单审批通过: " + execution.getVariable("orderNo"));]]></flowable:string>
                    </flowable:field>
                    <flowable:field name="language">
                        <flowable:string>groovy</flowable:string>
                    </flowable:field>
                </flowable:executionListener>
            </extensionElements>
        </endEvent>

        <!-- 结束事件：审批拒绝 -->
        <endEvent id="rejectedEndEvent" name="审批拒绝">
            <extensionElements>
                <flowable:executionListener event="start" class="org.flowable.engine.impl.bpmn.listener.ScriptExecutionListener">
                    <flowable:field name="script">
                        <flowable:string><![CDATA[System.out.println("订单审批拒绝: " + execution.getVariable("orderNo"));]]></flowable:string>
                    </flowable:field>
                    <flowable:field name="language">
                        <flowable:string>groovy</flowable:string>
                    </flowable:field>
                </flowable:executionListener>
            </extensionElements>
        </endEvent>

        <!-- 序列流 -->
        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="approveTask" />
        <sequenceFlow id="flow2" sourceRef="approveTask" targetRef="decisionGateway" />
        <sequenceFlow id="flow3" sourceRef="decisionGateway" targetRef="approvedEndEvent">
            <conditionExpression xsi:type="tFormalExpression">${approved}</conditionExpression>
        </sequenceFlow>
        <sequenceFlow id="flow4" sourceRef="decisionGateway" targetRef="rejectedEndEvent">
            <conditionExpression xsi:type="tFormalExpression">${!approved}</conditionExpression>
        </sequenceFlow>
    </process>
</definitions>